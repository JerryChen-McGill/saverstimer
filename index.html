<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAVERS è®¡æ—¶å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 25px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .global-settings {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
        }

        .total-time {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }

        .total-label {
            font-size: 1.1em;
            font-weight: normal;
        }

        .total-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-left: 10px;
        }

        .global-settings h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .preset-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .preset-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .preset-btn:hover {
            background: #667eea;
            color: white;
        }

        .preset-buttons input {
            flex: 1.5;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .preset-buttons button:last-child {
            flex: 1;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        .preset-buttons button:last-child:hover {
            background: #5568d3;
        }

        .activity-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            border: 3px solid transparent;
            transition: all 0.3s;
        }

        .activity-item.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            transform: scale(1.02);
        }

        .activity-item.completed {
            opacity: 0.6;
            background: #e8f5e9;
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .activity-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            flex: 1;
        }

        .activity-input {
            width: 80px;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            font-size: 1em;
            font-weight: bold;
        }

        .activity-time {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin: 10px 0;
        }

        .activity-controls {
            display: none;
        }

        .main-controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .main-controls button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .play-pause-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: relative;
        }

        .play-pause-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .play-pause-btn.paused {
            background: #ffa726;
        }

        .play-pause-btn.paused:hover {
            background: #fb8c00;
        }

        .play-pause-icon {
            font-size: 1.2em;
            display: inline-block;
        }

        .reset-btn {
            background: #ef5350;
            color: white;
        }

        .reset-btn:hover {
            background: #e53935;
        }

        .status {
            text-align: center;
            margin-top: 15px;
            font-size: 1.1em;
            color: #667eea;
            font-weight: bold;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .activity-item {
            cursor: pointer;
        }

        .activity-item.active {
            cursor: pointer;
        }

        /* ä¸»è§†å›¾å¼¹çª—æ ·å¼ */
        .main-view-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        .main-view-modal.show {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .main-view-content {
            background: white;
            border-radius: 30px;
            padding: 60px 40px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            height: auto;
            min-height: 400px;
            transition: all 0.3s ease;
        }

        .main-view-content.transition {
            padding: 0;
            overflow: hidden;
        }

        .main-view-single {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 60px 40px;
            transition: opacity 0.3s ease;
        }

        .main-view-transition {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 400px;
        }

        .main-view-previous {
            flex: 0 0 40%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%);
            border-bottom: 2px solid #ddd;
            transition: all 0.3s ease;
        }

        .main-view-current {
            flex: 0 0 60%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
            background: white;
            transition: all 0.3s ease;
        }

        .main-view-transition.fade-out .main-view-previous {
            opacity: 0;
            transform: translateY(-20px);
        }

        .main-view-transition.fade-out .main-view-current {
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .main-view-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border: none;
            background: #f0f0f0;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .main-view-close:hover {
            background: #e0e0e0;
            transform: rotate(90deg);
        }

        .main-view-title {
            font-size: 2.5em;
            color: #667eea;
            margin-bottom: 40px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .main-view-timer {
            font-size: 6em;
            font-weight: bold;
            color: #667eea;
            margin: 30px 0;
            font-family: 'Courier New', monospace;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .main-view-title-small {
            font-size: 1.5em;
            color: #666;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .main-view-timer-small {
            font-size: 3em;
            font-weight: bold;
            color: #999;
            font-family: 'Courier New', monospace;
        }

        .add-time-btn {
            margin-top: 20px;
            padding: 12px 30px;
            background: #e8e8e8;
            color: #666;
            border: 1px solid #d0d0d0;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: normal;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: none;
        }

        .add-time-btn:hover {
            background: #d8d8d8;
            color: #555;
            border-color: #c0c0c0;
        }

        .add-time-btn:active {
            background: #d0d0d0;
        }

        .add-time-btn-previous {
            margin-top: 15px;
            padding: 10px 25px;
            background: #e8e8e8;
            color: #666;
            border: 1px solid #d0d0d0;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: normal;
            cursor: pointer;
            transition: all 0.3s;
        }

        .add-time-btn-previous:hover {
            background: #d8d8d8;
            color: #555;
            border-color: #c0c0c0;
        }

        @media (max-width: 600px) {
            .main-view-content {
                padding: 40px 30px;
            }

            .main-view-title {
                font-size: 2em;
                margin-bottom: 30px;
            }

            .main-view-timer {
                font-size: 4em;
            }
        }
    </style>
</head>
<body>
    <!-- ä¸»è§†å›¾å¼¹çª— -->
    <div class="main-view-modal" id="mainViewModal" onclick="handleModalClick(event)">
        <div class="main-view-content" id="mainViewContent" onclick="event.stopPropagation()">
            <button class="main-view-close" onclick="closeMainView()">Ã—</button>
            
            <!-- å•ç¯èŠ‚æ˜¾ç¤º -->
            <div class="main-view-single" id="mainViewSingle">
                <div class="main-view-title" id="mainViewTitle">æ´»åŠ¨åç§°</div>
                <div class="main-view-timer" id="mainViewTimer">00:00</div>
                <button class="add-time-btn" onclick="addTime(1)">åŠ æ—¶1åˆ†é’Ÿ</button>
            </div>
            
            <!-- è¿‡æ¸¡æ˜¾ç¤ºï¼ˆä¸Šä¸‹åˆ†å—ï¼‰ -->
            <div class="main-view-transition" id="mainViewTransition" style="display: none;">
                <div class="main-view-previous">
                    <div class="main-view-title-small" id="previousViewTitle">ä¸Šä¸€ä¸ªç¯èŠ‚</div>
                    <div class="main-view-timer-small" id="previousViewTimer">00:00</div>
                    <button class="add-time-btn-previous" onclick="addTimeToPrevious()">å†æ¥1åˆ†é’Ÿ</button>
                </div>
                <div class="main-view-current">
                    <div class="main-view-title" id="currentViewTitle">å½“å‰ç¯èŠ‚</div>
                    <div class="main-view-timer" id="currentViewTimer">00:00</div>
                    <button class="add-time-btn" onclick="addTime(1)">åŠ æ—¶1åˆ†é’Ÿ</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>SAVERS è®¡æ—¶å™¨</h1>
        
        <div class="global-settings">
            <div class="total-time">
                <span class="total-label">æ€»æ—¶é•¿ï¼š</span>
                <span class="total-value" id="totalTime">30:00</span>
            </div>
            <h3>å¿«é€Ÿè®¾ç½®æ¯é¡¹æ—¶é•¿</h3>
            <div class="preset-buttons">
                <button class="preset-btn" onclick="setAllTimes(3)">3åˆ†é’Ÿ</button>
                <button class="preset-btn" onclick="setAllTimes(10)">10åˆ†é’Ÿ</button>
                <input type="number" id="customMinutes" min="1" max="60" placeholder="è‡ªå®šä¹‰" oninput="handleCustomTimeInput(event)">
            </div>
            
            <div class="main-controls">
                <button class="play-pause-btn" id="playPauseBtn" onclick="togglePlayPause()">
                    <span class="play-pause-icon" id="playPauseIcon">â–¶</span>
                </button>
                <button class="reset-btn" onclick="resetTimer()">é‡ç½®</button>
            </div>
            
            <div class="status" id="status">å‡†å¤‡å°±ç»ª</div>
        </div>

        <div id="activities"></div>
    </div>

    <script>
        const activities = [
            { name: 'S - Silence (å†¥æƒ³)', time: 300 },
            { name: 'A - Affirmations (è‚¯å®š)', time: 300 },
            { name: 'V - Visualization (æƒ³è±¡)', time: 300 },
            { name: 'E - Exercise (è¿åŠ¨)', time: 300 },
            { name: 'R - Reading (é˜…è¯»)', time: 300 },
            { name: 'S - Scribing (å†™ä½œ)', time: 300 }
        ];

        let currentIndex = 0;
        let isRunning = false;
        let isPaused = false;
        let timer = null;
        let remainingTime = 0;
        let endTime = 0;
        let isMainViewOpen = false;
        let previousActivityIndex = -1;
        let previousActivityTime = 0;
        let transitionTimer = null;
        let isInTransition = false;
        let activityStartTime = {}; // è®°å½•æ¯ä¸ªç¯èŠ‚å¼€å§‹æ—¶çš„åŸå§‹æ—¶é—´
        let activityActualTime = {}; // è®°å½•æ¯ä¸ªç¯èŠ‚çš„å®é™…ä½¿ç”¨æ—¶é•¿
        let activityAddedTime = {}; // è®°å½•æ¯ä¸ªç¯èŠ‚çš„åŠ æ—¶æ—¶é•¿æ€»å’Œ

        function initializeActivities() {
            const container = document.getElementById('activities');
            container.innerHTML = '';
            
            activities.forEach((activity, index) => {
                const div = document.createElement('div');
                div.className = 'activity-item';
                div.id = `activity-${index}`;
                div.innerHTML = `
                    <div class="activity-header">
                        <div class="activity-name">${activity.name}</div>
                        <select class="activity-input" id="input-${index}" onchange="updateActivityTime(${index})">
                            ${generateTimeOptions(Math.floor(activity.time / 60))}
                        </select>
                    </div>
                    <div class="activity-time" id="time-${index}">${formatTime(activity.time)}</div>
                    <div class="activity-controls">
                        <input type="number" id="old-input-${index}" min="1" max="60" 
                               value="${Math.floor(activity.time / 60)}" 
                               onchange="updateActivityTime(${index})"
                               placeholder="åˆ†é’Ÿ">
                    </div>
                `;
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å‡»æ´»åŠ¨é¢æ¿æ—¶æ‰“å¼€ä¸»è§†å›¾
                div.addEventListener('click', function(e) {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯selectä¸‹æ‹‰æ¡†ï¼Œä¸è§¦å‘æ‰“å¼€ä¸»è§†å›¾
                    if (e.target.tagName === 'SELECT') {
                        return;
                    }
                    // å¦‚æœè¯¥æ´»åŠ¨æ­£åœ¨è®¡æ—¶ï¼Œæ‰“å¼€ä¸»è§†å›¾
                    if (isRunning && !isPaused && currentIndex === index) {
                        showMainView();
                    }
                });
                container.appendChild(div);
            });
        }

        function generateTimeOptions(selectedMinutes) {
            let options = '';
            for (let i = 1; i <= 60; i++) {
                const selected = i === selectedMinutes ? 'selected' : '';
                options += `<option value="${i}" ${selected}>${i}åˆ†é’Ÿ</option>`;
            }
            return options;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function setAllTimes(minutes) {
            activities.forEach((activity, index) => {
                activity.time = minutes * 60;
                const selectElement = document.getElementById(`input-${index}`);
                if (selectElement) {
                    selectElement.value = minutes;
                }
                document.getElementById(`time-${index}`).textContent = formatTime(activity.time);
            });
            updateTotalTime();
        }

        function handleCustomTimeInput(event) {
            const input = event.target;
            let value = input.value;
            
            // åªå…è®¸è¾“å…¥æ•°å­—ï¼Œè¿‡æ»¤éæ•°å­—å­—ç¬¦
            value = value.replace(/\D/g, '');
            input.value = value;
            
            // å¦‚æœæœ‰æœ‰æ•ˆæ•°å­—ï¼Œå®æ—¶æ›´æ–°æ‰€æœ‰æ´»åŠ¨çš„æ—¶é•¿
            if (value) {
                const minutes = parseInt(value);
                if (minutes > 0 && minutes <= 60) {
                    setAllTimes(minutes);
                }
            }
        }

        function togglePlayPause() {
            if (!isRunning) {
                startTimer();
            } else if (isPaused) {
                startTimer(); // æ¢å¤
            } else {
                pauseTimer();
            }
        }

        function updatePlayPauseButton() {
            const btn = document.getElementById('playPauseBtn');
            const icon = document.getElementById('playPauseIcon');
            
            if (!isRunning || isPaused) {
                // æ˜¾ç¤ºæ’­æ”¾å›¾æ ‡
                icon.textContent = 'â–¶';
                btn.classList.remove('paused');
            } else {
                // æ˜¾ç¤ºæš‚åœå›¾æ ‡
                icon.textContent = 'â¸';
                btn.classList.add('paused');
            }
        }

        function updateActivityTime(index) {
            const selectElement = document.getElementById(`input-${index}`);
            const minutes = parseInt(selectElement.value);
            if (minutes && minutes > 0 && minutes <= 60) {
                activities[index].time = minutes * 60;
                document.getElementById(`time-${index}`).textContent = formatTime(activities[index].time);
                updateTotalTime();
            }
        }

        function updateTotalTime() {
            // è®¡ç®—åˆå§‹æ€»æ—¶é•¿
            const initialTotal = activities.reduce((sum, activity) => sum + activity.time, 0);
            
            // è®¡ç®—æ‰€æœ‰ç¯èŠ‚çš„åŠ æ—¶æ—¶é•¿æ€»å’Œ
            const totalAddedTime = Object.values(activityAddedTime).reduce((sum, time) => sum + time, 0);
            
            // æ€»æ—¶é•¿ = åˆå§‹æ€»æ—¶é•¿ + æ‰€æœ‰åŠ æ—¶æ—¶é•¿
            const total = initialTotal + totalAddedTime;
            document.getElementById('totalTime').textContent = formatTime(total);
        }

        function showMainView() {
            if (!isRunning || isPaused) return;
            
            const modal = document.getElementById('mainViewModal');
            modal.classList.add('show');
            isMainViewOpen = true;
            
            updateMainViewDisplay();
        }

        function closeMainView() {
            const modal = document.getElementById('mainViewModal');
            modal.classList.remove('show');
            isMainViewOpen = false;
        }

        function handleModalClick(event) {
            // å¦‚æœç‚¹å‡»çš„æ˜¯èƒŒæ™¯ï¼ˆé®ç½©å±‚ï¼‰ï¼Œå…³é—­å¼¹çª—
            if (event.target.id === 'mainViewModal') {
                closeMainView();
            }
        }

        function updateMainViewDisplay() {
            if (!isMainViewOpen || !isRunning || isPaused) return;
            
            if (isInTransition) {
                // è¿‡æ¸¡æ¨¡å¼ï¼šæ›´æ–°ä¸¤ä¸ªè§†å›¾
                const currentTitle = document.getElementById('currentViewTitle');
                const currentTimer = document.getElementById('currentViewTimer');
                const previousTitle = document.getElementById('previousViewTitle');
                const previousTimer = document.getElementById('previousViewTimer');
                
                currentTitle.textContent = activities[currentIndex].name;
                currentTimer.textContent = formatTime(remainingTime);
                
                if (previousActivityIndex >= 0) {
                    previousTitle.textContent = activities[previousActivityIndex].name;
                    previousTimer.textContent = formatTime(previousActivityTime);
                }
            } else {
                // å•ç¯èŠ‚æ¨¡å¼
                const title = document.getElementById('mainViewTitle');
                const timer = document.getElementById('mainViewTimer');
                
                title.textContent = activities[currentIndex].name;
                timer.textContent = formatTime(remainingTime);
            }
        }

        function updateMainView() {
            updateMainViewDisplay();
        }

        function addTime(minutes) {
            if (!isRunning || isPaused) return;
            
            // è®¡ç®—åŠ æ—¶å‰å·²ä½¿ç”¨çš„æ—¶é—´
            const originalTime = activityStartTime[currentIndex] || activities[currentIndex].time;
            const elapsedBeforeAdd = originalTime - remainingTime;
            
            // ç´¯åŠ åˆ°å®é™…ä½¿ç”¨æ—¶é•¿
            if (!activityActualTime[currentIndex]) {
                activityActualTime[currentIndex] = 0;
            }
            activityActualTime[currentIndex] += elapsedBeforeAdd;
            
            // åŠ æ—¶
            const additionalSeconds = minutes * 60;
            remainingTime += additionalSeconds;
            endTime = Date.now() + remainingTime * 1000;
            
            // è®°å½•åŠ æ—¶æ—¶é•¿
            if (!activityAddedTime[currentIndex]) {
                activityAddedTime[currentIndex] = 0;
            }
            activityAddedTime[currentIndex] += additionalSeconds;
            
            // æ›´æ–°è®°å½•çš„å¼€å§‹æ—¶é—´ï¼ˆåŠ æ—¶åçš„æ–°æ—¶é—´ï¼‰
            activityStartTime[currentIndex] = remainingTime;
            
            // æ›´æ–°æ€»æ—¶é•¿
            updateTotalTime();
            
            updateMainViewDisplay();
        }

        function addTimeToPrevious() {
            if (!isRunning || isPaused || !isInTransition || previousActivityIndex < 0) return;
            
            // è®¡ç®—å½“å‰ç¯èŠ‚å·²ç»å€’è®¡æ—¶çš„ç§’æ•°
            const currentOriginalTime = activityStartTime[currentIndex] || activities[currentIndex].time;
            const currentElapsed = currentOriginalTime - remainingTime; // å·²å€’è®¡æ—¶çš„ç§’æ•°
            
            // ä¸Šä¸€ä¸ªç¯èŠ‚è·å¾—ï¼š1åˆ†é’Ÿ - å½“å‰ç¯èŠ‚å·²å€’è®¡æ—¶çš„ç§’æ•°
            // ä¾‹å¦‚ï¼šå½“å‰ç¯èŠ‚å·²å€’è®¡æ—¶8ç§’ï¼Œåˆ™ä¸Šä¸€ä¸ªç¯èŠ‚è·å¾— 60 - 8 = 52ç§’
            const newTimeForPrevious = 60 - currentElapsed;
            
            // è®°å½•å½“å‰ç¯èŠ‚çš„å®é™…ä½¿ç”¨æ—¶é•¿ï¼ˆç”¨äºç»Ÿè®¡ï¼‰
            if (!activityActualTime[currentIndex]) {
                activityActualTime[currentIndex] = 0;
            }
            activityActualTime[currentIndex] += currentElapsed;
            
            // ä¿å­˜åŸæ¥çš„å½“å‰ç¯èŠ‚ç´¢å¼•ï¼ˆå°†è¢«è·³è¿‡ï¼‰
            const skippedIndex = currentIndex;
            
            // ç»“æŸè¿‡æ¸¡ï¼Œåˆ‡æ¢åˆ°å•ç¯èŠ‚æ¨¡å¼
            endTransition();
            
            // åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªç¯èŠ‚
            currentIndex = previousActivityIndex;
            remainingTime = newTimeForPrevious; // æ˜¾ç¤ºå®é™…è·å¾—çš„ç§’æ•°ï¼ˆå¦‚52ç§’ï¼‰
            endTime = Date.now() + remainingTime * 1000;
            
            // è®°å½•ä¸Šä¸€ä¸ªç¯èŠ‚çš„åŠ æ—¶æ—¶é•¿ï¼ˆå›ºå®š60ç§’ï¼Œç”¨äºæ€»æ—¶é•¿è®¡ç®—ï¼‰
            if (!activityAddedTime[currentIndex]) {
                activityAddedTime[currentIndex] = 0;
            }
            activityAddedTime[currentIndex] += 60; // å›ºå®šè®°å½•60ç§’ä½œä¸ºåŠ æ—¶æ—¶é•¿
            
            // è®°å½•æ–°ç¯èŠ‚çš„å¼€å§‹æ—¶é—´ï¼ˆç”¨äºåç»­è®¡ç®—ï¼‰
            activityStartTime[currentIndex] = remainingTime;
            
            // ç«‹å³æ›´æ–°æ€»æ—¶é•¿
            updateTotalTime();
            
            // æ›´æ–°æ´»åŠ¨çŠ¶æ€
            document.querySelectorAll('.activity-item').forEach((item, index) => {
                item.classList.remove('active', 'completed');
                if (index === currentIndex) {
                    item.classList.add('active');
                } else if (index < currentIndex) {
                    item.classList.add('completed');
                }
                // è¢«è·³è¿‡çš„ç¯èŠ‚ä¿æŒæœªå®ŒæˆçŠ¶æ€ï¼ˆç§»é™¤completedï¼‰
                if (index === skippedIndex) {
                    item.classList.remove('completed');
                }
            });
            
            document.getElementById('status').textContent = `è¿›è¡Œä¸­: ${activities[currentIndex].name}`;
            document.getElementById(`time-${currentIndex}`).textContent = formatTime(remainingTime);
            
            // æ¸…é™¤è¢«è·³è¿‡ç¯èŠ‚çš„å€’è®¡æ—¶æ˜¾ç¤ºï¼Œæ¢å¤ä¸ºåˆå§‹æ—¶é—´
            if (skippedIndex < activities.length) {
                document.getElementById(`time-${skippedIndex}`).textContent = formatTime(activities[skippedIndex].time);
            }
            
            updateMainViewDisplay();
        }

        function startTransition(prevIndex, prevTime) {
            isInTransition = true;
            previousActivityIndex = prevIndex;
            previousActivityTime = prevTime;
            
            const content = document.getElementById('mainViewContent');
            const single = document.getElementById('mainViewSingle');
            const transition = document.getElementById('mainViewTransition');
            
            content.classList.add('transition');
            single.style.display = 'none';
            transition.style.display = 'flex';
            
            // æ›´æ–°è¿‡æ¸¡è§†å›¾å†…å®¹
            const previousTitle = document.getElementById('previousViewTitle');
            const previousTimer = document.getElementById('previousViewTimer');
            const currentTitle = document.getElementById('currentViewTitle');
            const currentTimer = document.getElementById('currentViewTimer');
            
            previousTitle.textContent = activities[prevIndex].name;
            previousTimer.textContent = formatTime(prevTime);
            currentTitle.textContent = activities[currentIndex].name;
            currentTimer.textContent = formatTime(remainingTime);
            
            // 10ç§’åç»“æŸè¿‡æ¸¡
            if (transitionTimer) {
                clearTimeout(transitionTimer);
            }
            transitionTimer = setTimeout(() => {
                endTransition();
            }, 10000);
        }

        function endTransition() {
            if (!isInTransition) return;
            
            isInTransition = false;
            const content = document.getElementById('mainViewContent');
            const single = document.getElementById('mainViewSingle');
            const transition = document.getElementById('mainViewTransition');
            
            // æ·»åŠ æ·¡å‡ºåŠ¨ç”»
            transition.classList.add('fade-out');
            
            setTimeout(() => {
                content.classList.remove('transition');
                single.style.display = 'flex';
                transition.style.display = 'none';
                transition.classList.remove('fade-out');
                // æ›´æ–°å•ç¯èŠ‚æ˜¾ç¤º
                updateMainViewDisplay();
            }, 300);
            
            if (transitionTimer) {
                clearTimeout(transitionTimer);
                transitionTimer = null;
            }
        }

        let audioContext = null;

        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            // åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šï¼ŒAudioContext å¯èƒ½éœ€è¦ç”¨æˆ·äº¤äº’åæ‰èƒ½ä½¿ç”¨
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        function playBeep() {
            try {
                initAudioContext();
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                const now = audioContext.currentTime;
                gainNode.gain.setValueAtTime(0.3, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                
                oscillator.start(now);
                oscillator.stop(now + 0.5);
            } catch (error) {
                console.log('æ’­æ”¾æç¤ºéŸ³å¤±è´¥:', error);
                // å¦‚æœéŸ³é¢‘æ’­æ”¾å¤±è´¥ï¼Œä½¿ç”¨æŒ¯åŠ¨ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
                if (navigator.vibrate) {
                    navigator.vibrate(200);
                }
            }
        }

        function startTimer() {
            if (isRunning && !isPaused) return;
            
            // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆç§»åŠ¨è®¾å¤‡éœ€è¦ç”¨æˆ·äº¤äº’ï¼‰
            initAudioContext();
            
            if (!isRunning) {
                currentIndex = 0;
                remainingTime = activities[currentIndex].time;
                document.querySelectorAll('.activity-item').forEach(item => {
                    item.classList.remove('active', 'completed');
                });
                // æ¸…é™¤è¿‡æ¸¡çŠ¶æ€
                if (isInTransition) {
                    endTransition();
                }
                // é‡ç½®è®°å½•
                activityStartTime = {};
                activityActualTime = {};
                activityAddedTime = {};
            }
            
            isRunning = true;
            isPaused = false;
            endTime = Date.now() + remainingTime * 1000;
            
            // è®°å½•å½“å‰ç¯èŠ‚çš„å¼€å§‹æ—¶é—´
            activityStartTime[currentIndex] = remainingTime;
            
            // æ›´æ–°æ’­æ”¾/æš‚åœæŒ‰é’®çŠ¶æ€
            updatePlayPauseButton();
            document.getElementById('status').textContent = `è¿›è¡Œä¸­: ${activities[currentIndex].name}`;
            document.getElementById(`activity-${currentIndex}`).classList.add('active');
            
            // æ˜¾ç¤ºä¸»è§†å›¾
            showMainView();
            
            timer = setInterval(() => {
                const now = Date.now();
                remainingTime = Math.max(0, Math.ceil((endTime - now) / 1000));
                document.getElementById(`time-${currentIndex}`).textContent = formatTime(remainingTime);
                
                // æ›´æ–°ä¸»è§†å›¾ä¸­çš„å€’è®¡æ—¶
                updateMainView();
                
                if (remainingTime <= 0) {
                    playBeep();
                    
                    // è®°å½•å½“å‰ç¯èŠ‚çš„å®é™…ä½¿ç”¨æ—¶é•¿ï¼ˆæœ€åä¸€æ®µï¼‰
                    const originalTime = activityStartTime[currentIndex] || activities[currentIndex].time;
                    const finalElapsed = originalTime; // æœ€åä¸€æ®µå®Œæ•´ä½¿ç”¨å®Œ
                    if (!activityActualTime[currentIndex]) {
                        activityActualTime[currentIndex] = 0;
                    }
                    activityActualTime[currentIndex] += finalElapsed;
                    
                    // ä¿å­˜ä¸Šä¸€ä¸ªç¯èŠ‚çš„ä¿¡æ¯
                    const prevIndex = currentIndex;
                    const prevTime = activities[prevIndex].time; // ä¸Šä¸€ä¸ªç¯èŠ‚çš„åŸå§‹æ—¶é•¿
                    
                    // æ›´æ–°ä¸»é¡µæ˜¾ç¤ºï¼šæ˜¾ç¤ºè¯¥ç¯èŠ‚çš„æ€»æ—¶é•¿ï¼ˆåŸå§‹æ—¶é•¿ + å›ºå®šçš„åŠ æ—¶æ—¶é•¿ï¼‰
                    const addedTime = activityAddedTime[prevIndex] || 0; // å›ºå®šçš„åŠ æ—¶æ—¶é•¿ï¼ˆ60ç§’ï¼‰
                    const totalTimeUsed = prevTime + addedTime;
                    document.getElementById(`time-${prevIndex}`).textContent = formatTime(totalTimeUsed);
                    
                    document.getElementById(`activity-${currentIndex}`).classList.remove('active');
                    document.getElementById(`activity-${currentIndex}`).classList.add('completed');
                    
                    currentIndex++;
                    
                    if (currentIndex < activities.length) {
                        remainingTime = activities[currentIndex].time;
                        endTime = Date.now() + remainingTime * 1000;
                        
                        // è®°å½•æ–°ç¯èŠ‚çš„å¼€å§‹æ—¶é—´
                        activityStartTime[currentIndex] = remainingTime;
                        
                        document.getElementById(`activity-${currentIndex}`).classList.add('active');
                        document.getElementById('status').textContent = `è¿›è¡Œä¸­: ${activities[currentIndex].name}`;
                        
                        // å¦‚æœä¸»è§†å›¾æ²¡æœ‰æ‰“å¼€ï¼Œè‡ªåŠ¨å¼¹å‡º
                        if (!isMainViewOpen) {
                            showMainView();
                        }
                        
                        // å¯åŠ¨è¿‡æ¸¡æ˜¾ç¤ºï¼ˆ10ç§’ï¼‰
                        startTransition(prevIndex, prevTime);
                    } else {
                        // å…¨éƒ¨å®Œæˆ
                        if (isInTransition) {
                            endTransition();
                        }
                        clearInterval(timer);
                        isRunning = false;
                        updatePlayPauseButton();
                        document.getElementById('status').textContent = 'å…¨éƒ¨å®Œæˆï¼æ­å–œä½ ï¼ğŸ‰';
                        closeMainView();
                        playBeep();
                        setTimeout(playBeep, 200);
                        setTimeout(playBeep, 400);
                    }
                }
            }, 100);
        }

        function pauseTimer() {
            if (!isRunning || isPaused) return;
            
            isPaused = true;
            clearInterval(timer);
            updatePlayPauseButton();
            document.getElementById('status').textContent = 'å·²æš‚åœ';
        }

        function resetTimer() {
            clearInterval(timer);
            isRunning = false;
            isPaused = false;
            currentIndex = 0;
            
            // æ¸…é™¤è¿‡æ¸¡çŠ¶æ€
            if (isInTransition) {
                endTransition();
            }
            if (transitionTimer) {
                clearTimeout(transitionTimer);
                transitionTimer = null;
            }
            
            // æ¸…é™¤è®°å½•
            activityStartTime = {};
            activityActualTime = {};
            activityAddedTime = {};
            
            // å…³é—­ä¸»è§†å›¾
            closeMainView();
            
            updatePlayPauseButton();
            document.getElementById('status').textContent = 'å‡†å¤‡å°±ç»ª';
            
            document.querySelectorAll('.activity-item').forEach(item => {
                item.classList.remove('active', 'completed');
            });
            
            activities.forEach((activity, index) => {
                document.getElementById(`time-${index}`).textContent = formatTime(activity.time);
            });
            
            // æ›´æ–°æ€»æ—¶é•¿
            updateTotalTime();
        }

        initializeActivities();
        updateTotalTime();
        updatePlayPauseButton();
    </script>
</body>
</html>